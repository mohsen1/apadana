#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"

# Only proceed if this is not an existing commit message
if [ "$COMMIT_SOURCE" = "" ]; then
  DIFF=$(git diff --cached)

  # Check if file has any non-comment, non-empty lines
  NON_COMMENT_LINES=$(grep -v '^#' "$COMMIT_MSG_FILE" | grep -v '^[[:space:]]*$' || true)

  if [ -z "$NON_COMMENT_LINES" ]; then
    SUMMARY=$(
      ollama run phi4 <<EOF
Generate a raw text commit message for the following diff.
Keep commit message concise and to the point.
First line plain text for title (100 characters max) 
One empty line after title
The rest of the message is markdown formatted body
DO NOT wrap the entire output in code block
$DIFF
EOF
    )

    echo "$SUMMARY" >"$COMMIT_MSG_FILE"
  fi
fi
